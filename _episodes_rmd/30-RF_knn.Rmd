---
title: "Random forest and kNN regression."
author: "Darya Vanichkina"
source: Rmd
start: 0
teaching: 30
exercises: 0
---
```{r echo=FALSE}
source("../bin/chunk-options.R")
knitr_fig_path("30-")
```


```{r loadLibraries}
library(tidyverse)
library(caret)
library(ranger)
library(tidymodels)
library(AmesHousing)
theme_set(theme_minimal())
```

```{r getData}
ameshousingFiltTrain <- readRDS("models/ameshousingFiltTrain.Rds")
ameshousingFiltTest <- readRDS("models/ameshousingFiltTest.Rds")

ameshousingFiltTrain_engineered <- readRDS("models/ameshousingFiltTrain_engineered.Rds")
ameshousingFiltTest_engineered <-readRDS("models/ameshousingFiltTest_engineered.Rds")

ames_resamplingCV <- readRDS("models/ames_resamplingCV.Rds")

ames_lm_all <- readRDS("models/ames_lm_all.Rds")
ames_mars <- readRDS("models/ames_mars.Rds")
ames_ridge <- readRDS("models/ames_ridge.Rds")
ames_lasso <- readRDS("models/ames_lasso.Rds")
ames_en <- readRDS("models/ames_en.Rds")
ames_plsr <- readRDS("models/ames_plsr.Rds")
ames_pcr <- readRDS("models/ames_pcr.Rds")
```



```{r RFoptimise}
flnm = "models/ames_rf.Rds"

if (!file.exists(flnm)){
  
  
  # tuning grid
  grid_search <- expand.grid(
    mtry = floor(dim(ameshousingFiltTrain)[2] * c(.15, .20, .25)),
    min.node.size = c(2,4,6),
    splitrule = c("variance", "extratrees")
  )
  # perform resampling
  set.seed(42)
  ames_rf <- train(
    log(Sale_Price) ~ .,
    data = ameshousingFiltTrain,
    trControl = ames_resamplingCV,
    method = "ranger",
    tuneGrid = grid_search,
    metric = "RMSE",
    num.trees = 1000,
    respect.unordered.factors = 'order'
  )
  saveRDS(ames_rf, flnm)
  
} else {
  
  ames_rf <- readRDS(flnm)
  
}

summary(ames_rf)


ames_rf$results %>%
  filter(
    mtry == ames_rf$bestTune$mtry,
    min.node.size == ames_rf$bestTune$min.node.size,
    splitrule == ames_rf$bestTune$splitrule
  )



summary(ames_rf)


ames_rf$results %>%
  filter(
    mtry == ames_rf$bestTune$mtry,
    min.node.size == ames_rf$bestTune$min.node.size,
    splitrule == ames_rf$bestTune$splitrule
    )






```


```{r ranger, cache=TRUE}

ames_rfOpt <- ranger(
  formula         = Sale_Price ~ ., 
  data            = ameshousingFiltTrain, 
  num.trees       = 2000,
  mtry            = 20,
  min.node.size   = 2,
  sample.fraction = .8,
  replace         = FALSE,
  importance      = 'permutation',
  respect.unordered.factors = 'order',
  splitrule       = "variance",
  verbose         = FALSE,
  seed            = 42
  )


```











```{r KNN}

flnm = "models/ames_knn.Rds"

if (!file.exists(flnm)){
  
  
  hyper_grid <- expand.grid(k = seq(2, 26, by = 2))
  ames_knn <- train(
    Sale_Price ~ .,
    data = ameshousingFiltTrain_engineered,
    method = "knn",
    trControl = ames_resamplingCV,
    tuneGrid = hyper_grid,
    metric = "RMSE"
  )
  
  saveRDS(ames_knn, "models/ames_knn.Rds")
  
} else {
  
ames_knn <- readRDS("models/ames_knn.Rds")

}


ames_knn
```




```{r resample}
allResamples <- resamples(list(
                               "Ridge" = ames_ridge,
                               "Lasso" = ames_lasso,
                               "EN" = ames_en,
                               "PLSR" = ames_plsr, 
                               "PCR" = ames_pcr,
                               "MARS" = ames_mars,
                               "LM all" = ames_lm_all,
                               "RF" = ames_rf, 
                               "KNN" = ames_knn
                               ))

bwplot(allResamples)
parallelplot(allResamples)

parallelplot(allResamples , metric = "Rsquared")
parallelplot(allResamples , metric = "RMSE")

summary(allResamples)$statistics$RMSE %>% 
  as.data.frame() %>% 
  rownames_to_column()  %>% 
  arrange(Median)
```