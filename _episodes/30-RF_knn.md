---
# Please do not edit this file directly; it is auto generated.
# Instead, please edit 30-RF_knn.md in _episodes_rmd/
title: "Random forest and kNN regression. ."
author: "Darya Vanichkina"
keypoints:
- FIXME
objectives:
- FIXME
questions:
- FIXME
source: Rmd
start: 0
teaching: 30
exercises: 0
---




~~~
library(tidyverse)
~~~
{: .language-r}



~~~
── Attaching packages ────────────────────────────────── tidyverse 1.2.1 ──
~~~
{: .output}



~~~
✔ ggplot2 3.1.0       ✔ purrr   0.3.1  
✔ tibble  2.0.1       ✔ dplyr   0.8.0.1
✔ tidyr   0.8.3       ✔ stringr 1.4.0  
✔ readr   1.3.1       ✔ forcats 0.4.0  
~~~
{: .output}



~~~
Warning: package 'tibble' was built under R version 3.5.2
~~~
{: .error}



~~~
Warning: package 'tidyr' was built under R version 3.5.2
~~~
{: .error}



~~~
Warning: package 'purrr' was built under R version 3.5.2
~~~
{: .error}



~~~
Warning: package 'dplyr' was built under R version 3.5.2
~~~
{: .error}



~~~
Warning: package 'stringr' was built under R version 3.5.2
~~~
{: .error}



~~~
Warning: package 'forcats' was built under R version 3.5.2
~~~
{: .error}



~~~
── Conflicts ───────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
~~~
{: .output}



~~~
library(caret)
~~~
{: .language-r}



~~~
Loading required package: lattice
~~~
{: .output}



~~~

Attaching package: 'caret'
~~~
{: .output}



~~~
The following object is masked from 'package:purrr':

    lift
~~~
{: .output}



~~~
library(tidymodels)
~~~
{: .language-r}



~~~
── Attaching packages ───────────────────────────────── tidymodels 0.0.2 ──
~~~
{: .output}



~~~
✔ broom     0.5.1     ✔ recipes   0.1.4
✔ dials     0.0.2     ✔ rsample   0.0.4
✔ infer     0.4.0     ✔ yardstick 0.0.3
✔ parsnip   0.0.1     
~~~
{: .output}



~~~
Warning: package 'rsample' was built under R version 3.5.2
~~~
{: .error}



~~~
Warning: package 'yardstick' was built under R version 3.5.2
~~~
{: .error}



~~~
── Conflicts ──────────────────────────────────── tidymodels_conflicts() ──
✖ scales::discard()      masks purrr::discard()
✖ dplyr::filter()        masks stats::filter()
✖ recipes::fixed()       masks stringr::fixed()
✖ dplyr::lag()           masks stats::lag()
✖ caret::lift()          masks purrr::lift()
✖ yardstick::precision() masks caret::precision()
✖ yardstick::recall()    masks caret::recall()
✖ yardstick::spec()      masks readr::spec()
✖ recipes::step()        masks stats::step()
~~~
{: .output}



~~~
library(AmesHousing)
old <- theme_set(theme_minimal())
rm(old)
~~~
{: .language-r}


~~~
ameshousingFiltTrain <- readRDS("models/ameshousingFiltTrain.Rds")
ameshousingFiltTest <- readRDS("models/ameshousingFiltTest.Rds")

ameshousingFiltTrain_engineered <- readRDS("models/ameshousingFiltTrain_engineered.Rds")
ameshousingFiltTest_engineered <-readRDS("models/ameshousingFiltTest_engineered.Rds")

ames_resamplingCV <- readRDS("models/ames_resamplingCV.Rds")

ames_lm_all <- readRDS("models/ames_lm_all.Rds")
ames_mars <- readRDS("models/ames_mars.Rds")
~~~
{: .language-r}




~~~
# # tuning grid
# grid_search <- expand.grid(
#   mtry = floor(dim(ameshousingFiltTrain)[2] * c(.15, .20, .25)),
#   min.node.size = c(2,4,6),
#   splitrule = c("variance", "extratrees")
# )
# # perform resampling
# set.seed(42)
# ames_rf <- train(
#   log(Sale_Price) ~ ., 
#   data = ameshousingFiltTrain, 
#   trControl = ames_resamplingCV,
#   method = "ranger",
#   tuneGrid = grid_search,
#   metric = "RMSE",
#   num.trees = 1000,
#   respect.unordered.factors = 'order'
#   )
# saveRDS(ames_rf, "models/ames_rf.Rds")

ames_rf <- readRDS("models/ames_rf.Rds")
summary(ames_rf)
~~~
{: .language-r}



~~~
                          Length Class         Mode     
predictions               2050   -none-        numeric  
num.trees                    1   -none-        numeric  
num.independent.variables    1   -none-        numeric  
mtry                         1   -none-        numeric  
min.node.size                1   -none-        numeric  
prediction.error             1   -none-        numeric  
forest                       9   ranger.forest list     
splitrule                    1   -none-        character
treetype                     1   -none-        character
r.squared                    1   -none-        numeric  
call                         9   -none-        call     
importance.mode              1   -none-        character
num.samples                  1   -none-        numeric  
replace                      1   -none-        logical  
xNames                     307   -none-        character
problemType                  1   -none-        character
tuneValue                    3   data.frame    list     
obsLevels                    1   -none-        logical  
param                        2   -none-        list     
~~~
{: .output}



~~~
ames_rf$results %>%
  filter(
    mtry == ames_rf$bestTune$mtry,
    min.node.size == ames_rf$bestTune$min.node.size,
    splitrule == ames_rf$bestTune$splitrule
    )
~~~
{: .language-r}



~~~
  mtry min.node.size splitrule      RMSE  Rsquared        MAE    RMSESD
1   20             2  variance 0.1410489 0.8865463 0.09239487 0.0217513
  RsquaredSD       MAESD
1 0.02948323 0.006278048
~~~
{: .output}



~~~
ames_rfOpt <- ranger(
  formula         = Sale_Price ~ ., 
  data            = ameshousingFiltTrain, 
  num.trees       = 2000,
  mtry            = 20,
  min.node.size   = 2,
  sample.fraction = .8,
  replace         = FALSE,
  importance      = 'permutation',
  respect.unordered.factors = 'order',
  splitrule       = "variance",
  verbose         = FALSE,
  seed            = 42
  )
~~~
{: .language-r}



~~~
Error in ranger(formula = Sale_Price ~ ., data = ameshousingFiltTrain, : could not find function "ranger"
~~~
{: .error}



~~~
plot(ames_rfOpt)
~~~
{: .language-r}



~~~
Error in plot(ames_rfOpt): object 'ames_rfOpt' not found
~~~
{: .error}





~~~
 vip(ames_rfOpt, num_features = 10) 
~~~
{: .language-r}



~~~
Error in vip(ames_rfOpt, num_features = 10): could not find function "vip"
~~~
{: .error}



~~~
vip(ames_lm_all, num_features = 10) 
~~~
{: .language-r}



~~~
Error in vip(ames_lm_all, num_features = 10): could not find function "vip"
~~~
{: .error}



~~~
allResamples <- resamples(list(
                               "Ridge" = ames_ridge,
                               "Lasso" = ames_lasso,
                               "EN" = ames_en,
                               "PLSR" = ames_plsr, 
                               "PCR" = ames_pcr,
                               "MARS" = ames_mars,
                               "LM all" = ames_lm_all,
                               "RF" = ames_rf
                               ))
~~~
{: .language-r}



~~~
Error in resamples(list(Ridge = ames_ridge, Lasso = ames_lasso, EN = ames_en, : object 'ames_ridge' not found
~~~
{: .error}



~~~
bwplot(allResamples)
~~~
{: .language-r}



~~~
Error in bwplot(allResamples): object 'allResamples' not found
~~~
{: .error}



~~~
parallelplot(allResamples)
~~~
{: .language-r}



~~~
Error in parallelplot(allResamples): object 'allResamples' not found
~~~
{: .error}



~~~
parallelplot(allResamples , metric = "Rsquared")
~~~
{: .language-r}



~~~
Error in parallelplot(allResamples, metric = "Rsquared"): object 'allResamples' not found
~~~
{: .error}



~~~
parallelplot(allResamples , metric = "RMSE")
~~~
{: .language-r}



~~~
Error in parallelplot(allResamples, metric = "RMSE"): object 'allResamples' not found
~~~
{: .error}



~~~
summary(allResamples)$statistics$RMSE %>% as.data.frame() %>% rownames_to_column()  %>% arrange(Median)
~~~
{: .language-r}



~~~
Error in summary(allResamples): object 'allResamples' not found
~~~
{: .error}




~~~
# 1. stratified sampling with the rsample package
set.seed(123)
split  <- initial_split(ames, prop = 0.7, strata = "Sale_Price")
~~~
{: .language-r}



~~~
Error in strata %in% vars: object 'ames' not found
~~~
{: .error}



~~~
ames_train  <- training(split)
~~~
{: .language-r}



~~~
Error: `x` should be an `rsplit` object
~~~
{: .error}



~~~
ames_test   <- testing(split)
~~~
{: .language-r}



~~~
Error: `x` should be an `rsplit` object
~~~
{: .error}



~~~
# 2. create a resampling method
cv <- trainControl(
  method = "repeatedcv", 
  number = 10, 
  repeats = 5
  )
# 3. create a hyperparameter grid search
hyper_grid <- expand.grid(k = seq(2, 26, by = 2))
# 4. execute grid search with knn model
#    use RMSE as preferred metric
knn_fit <- train(
  Sale_Price ~ ., 
  data = ames_train, 
  method = "knn", 
  trControl = cv, 
  tuneGrid = hyper_grid,
  metric = "RMSE"
  )
~~~
{: .language-r}



~~~
Error in eval(expr, p): object 'ames_train' not found
~~~
{: .error}



~~~
# 5. evaluate results
# print model results
knn_fit
~~~
{: .language-r}



~~~
Error in eval(expr, envir, enclos): object 'knn_fit' not found
~~~
{: .error}



~~~
## k-Nearest Neighbors 
## 
## 2054 samples
##   80 predictor
## 
## No pre-processing
## Resampling: Cross-Validated (10 fold, repeated 5 times) 
## Summary of sample sizes: 1848, 1850, 1848, 1848, 1848, 1848, ... 
## Resampling results across tuning parameters:
## 
##   k   RMSE      Rsquared   MAE     
##    2  46100.84  0.6618945  30205.06
~~~
{: .language-r}
